# PCA-from-VCF-files
This project demonstrates how to perform principal component analysis (PCA) using an aggregated VCF file or multiple non-aggregated VCF files.

# Principal Component Analysis (PCA) from VCF files

HELLO!
This document illustrates the process for performing a Principal Component Analysis (PCA) starting from a VCF file. It is necessary for the VCF file to contain the `GT` (genotype) field, as other fields are not considered for PCA.

PCA is a simple yet powerful clustering tool based on the decomposition of the data matrix. In our case, rows represent variants, and columns represent the genotypes of our samples. The goal is to find eigenvectors and eigenvalues.

Eigenvalues are sorted from largest to smallest. In short, the first eigenvalue indicates our first Principal Component (PC), and its direction in the PC space is given by the corresponding eigenvector. (This is an intentionally simplified and brief explanation).

Through this process, we are able to identify a lower-dimensional subspace, or an equivalent space, that "better" describes the distribution of our data.

## Prerequisites and Tools
To run this pipeline, you will need:
- PLINK version 1.9 (either [installed directly](https://www.cog-genomics.org/plink/) or via a [Docker container](https://github.com/asherkhb/plink-docker) ).
- BCFtools installed (either installed directly or via a Docker container [https://github.com/samtools/bcftools](url)).
- Two chromosome naming convention files:
    - The first file (in our case, named `chr_name_conv.txt`) must contain two columns: the first column with chromosome names like `chrN` (for N = 1, ...22, X, Y) and the second column with the corresponding `N` (for N = 1, ...22, X, Y).
    - The second file (in our case, named `no_chr_name_convention.txt`) must also contain two columns, but with the order inverted compared to the first file (i.e., `N` in the first column and `chrN` in the second).
    * **`no_chr_name_convention.txt`**: This file is used to convert chromosome names from the `chrN` style to the `N` style (i.e., removing the "chr" prefix). It is a tab-separated file where the first column is the chromosome name with the "chr" prefix, and the     second column is its corresponding numerical or symbolic representation.
      ---
        ```text
        chr1     1
        chr2     2
        chr3     3
        chr4     4
        chr5     5
        chr6     6
        chr7     7
        chr8     8
        chr9     9
        chr10    10
        chr11    11
        chr12    12
        chr13    13
        chr14    14
        chr15    15
        chr16    16
        chr17    17
        chr18    18
        chr19    19
        chr20    20
        chr21    21
        chr22    22
        chrX     X
        ```
        ---

    * **`chr_name_conv.txt`**: This file serves the opposite purpose, mapping numerical or symbolic chromosome names (without "chr") to the `chrN` convention. It is also a tab-separated file, with the numerical/symbolic name in the first column and the "chr" prefixed name in the second column.
      ---
        ```text
        1        chr1
        2        chr2
        3        chr3
        4        chr4
        5        chr5
        6        chr6
        7        chr7
        8        chr8
        9        chr9
        10       chr10
        11       chr11
        12       chr12
        13       chr13
        14       chr14
        15       chr15
        16       chr16
        17       chr17
        18       chr18
        19       chr19
        20       chr20
        21       chr21
        22       chr22
        23       chrX
        24       chrY
        25       chrXY
        26       chrMT
        ```
    ---


#### Plink

`Plink` accepts VCF files as input (which must be accompanied by their respective `.tbi` index file). It is crucial that the VCF file contains the `GT` (genotype) field for each sample.

**Note on `CHROM` field formatting**: It is not immediately clear whether the first column of the VCF (`CHROM`) should be numeric (e.g., `N`) or can include the "chr" prefix (e.g., `chrN`), where `N` is the chromosome number. It is recommended to consult the official `plink` documentation for this specific detail.

In any case, our input file will be a `vcf.gz` with its `.tbi` index file. For the procedures described below, it is assumed that the `CHROM` column contains chromosomes denoted as "`N`" and the `ID` column is formatted as "`CHROM:POS:REF:ALT`". However, modifying the `ID` column is not strictly necessary for PCA, as `plink` does not use it directly for this analysis.

The output files generated by `plink` for PCA will be three:
* A `.log` file
* An `.eigenvec` file (containing eigenvectors)
* An `.eigenval` file (containing eigenvalues)

From these files, dedicated pipelines can be used to create plots, analyze the explained variance of the data, or plot the different PCs using the `.eigenval` file.

## Optimizing Input Files: Working with Multiple Cohorts

Frequently, in studies, the need arises to compare multiple cohorts. For example, one might want to compare data from patients belonging to a "mesothelioma" cohort with data for the same pathology but originating from a different laboratory.

> #### NOTE
> If your only need is to merge two VCF files belonging to different cohorts, normalizing them, you can skip directly to step **3) Merging Cohorts**.

---

### 1) Merging VCF Files for a Single Cohort

If the data for a single cohort are distributed across multiple VCF files, they need to be merged.

With `bcftools`, you can merge all VCF files for your cohort. First, create a text file (e.g., `list_vcf.list`) that lists the full paths of all VCF files to be merged, one per line.

Example line in the `.list` file:
`path/to/file/sample1.vcf.gz`

Next, perform the merge:

```bash
bcftools merge --threads 64 -l list_vcf.list -Oz -o /path/to/merged_file_cohort1.vcf.gz
````

  * It is good practice to generate statistics with `bcftools stats` to verify the integrity of the generated file:

    ```bash
    bcftools stats merged_file_cohort1.vcf.gz > merged_file_cohort1.stat
    ```

    The file to inspect is `merged_file_cohort1.stat`.

  * **Splitting multi-allelic variants**: This is a recommended practice to separate records containing multiple alternative alleles. The goal is to have variants uniquely defined by `CHROM:POS:REF:ALT`.

    ```bash
    bcftools norm -m-any --check-ref w -f fasta_file.fa merged_file_cohort1.vcf.gz -Oz -o splt_merged_file_cohort1.vcf.gz
    ```

    Where `fasta_file.fa` is the reference genome used (e.g., `hg19.fa`). It is common for references like hg19 to have chromosomes named with `N` instead of `chrN`. Always check the specifications of the tool and the reference genome. Generally, these files (e.g., `hg19.fa`, `hg38.fa`) must be in the same directory as their index files (`.fai`).

> #### NOTE
>
> It is very important to split multi-allelic records. Often, alternative alleles can be represented as `<NON_REF>` (depending on how the VCFs were generated). Therefore, it is good practice to split multi-allelic variants and eliminate those that have `<NON_REF>` as an ALT allele.
>
> A subsequent step can be the correction of possible REF/ALT discrepancies with respect to the reference genome:
>
> ```bash
> bcftools +fixref splt_merged_file_cohort1.vcf.gz -Oz -o fixref_splt_merged_file_cohort1.vcf.gz -- -f fasta_file.fa --mode flip --discard
> ```

-----


### 2\) Normalizing VCF File Headers (Specific to a Case Study)

At this point, we might want to modify the VCF file headers so that the `CHROM` column uses the `N` notation (instead of `chrN`) and the `ID` column contains identifiers in the `CHROM:POS:REF:ALT` format instead of, for example, `rs` identifiers.
For these steps, the use of a mapping files `no_chr_name_convention.txt` and `chr_name_conv.txt` is assumed.

* **Creating the `ID` column in `CHROM:POS:REF:ALT` format**:

    ```bash
    bcftools annotate --rename-chrs /path/to/chr_name_conv.txt \
    /path/to/fixref_splt_merged_file_cohort1.vcf.gz | \
    bcftools norm -Ou -f /path/to/hg19.fa # or hg38.fa
    | \
    bcftools annotate -Oz -x ID -I +'%CHROM:%POS:%REF:%ALT' \
    -o /path/to/newID_fixref_splt_merged_file_cohort1.vcf.gz
    ```

  * **Changing the `CHROM` column nomenclature from `chrN` to `N`**:
   

    ```bash
    bcftools annotate --rename-chrs/path/to/no_chr_name_convention.txt \
    /path/to/newID_fixref_splt_merged_file_cohort1.vcf.gz \
    -Oz -o /path/to/noCHR_newID_fixref_splt_merged_file_cohort1.vcf.gz
    ```

> #### NOTE
>
> Step 2) is specific to particular normalization needs (like those mentioned in the NIG case study). If the `CHROM` and `ID` columns are already consistent and the `vcf.gz` files are aligned to the same reference genome, you can proceed directly to step 3).

-----

### 3\) Merging Cohorts

To merge two VCF files (e.g., one per cohort, already preprocessed as described above), `bcftools merge` is the recommended tool.

```bash
bcftools merge --threads 64 \
/path/to/noCHR_newID_fixref_splt_merged_file_cohort1.vcf.gz \
/path/to/noCHR_newID_fixref_splt_merged_file_cohort2.vcf.gz \
-Oz -o /path/to/merged_cohorts.vcf.gz
```

**Expected number of variants in the merged file**:

  * The total number of variants in the `merged_cohorts.vcf.gz` file will be: (Number of unique variants in file 1) + (Number of unique variants in file 2) + (Number of variants common to both files).
  * There will be no duplication of rows for common variants (same position, REF, and ALT). These will be merged into a single record containing sample data from both files.

-----

### 4\) Recommended Additional Checks

It is good practice to perform some checks on the final merged VCF file:

  * **Verify the number of variants**: Ensure it matches expectations (common variants + unique variants from both files).

    ```bash
    zgrep -v "#" merged_cohorts.vcf.gz | wc -l
    ```

    Run the same command on the original files for comparison.

  * **Recreate a statistics file**:

    ```bash
    bcftools stats merged_cohorts.vcf.gz > merged_cohorts.stat
    ```

  * **Check for any REF/ALT flips post-merge**:
    The `bcftools +fixref` command may require chromosomes to be in `chrN` format. If the merged file uses the `N` notation, temporary reconversion is necessary.

      * Rename chromosomes from `N` to `chrN` (using a mapping file like `chr_name_conv.txt`):

        ```bash
        bcftools annotate --rename-chrs /path/to/chr_name_conv.txt \
        /path/to/merged_cohorts.vcf.gz \
        -o /path/to/CHR_merged_cohorts.vcf.gz
        ```

      * **OPTIONAL** Use `fixref` to check and correct any flips:

        ```bash
        bcftools +fixref /path/to/CHR_merged_cohorts.vcf.gz \
        -Oz -o /path/to/FIXREF_CHR_merged_cohorts.vcf.gz \
        -- -f /path/to/hg19.fa # or hg38.fa
        --mode flip --discard
        ```

-----

## 9\) **OPTIONAL** Extracting Selected Variants

If you have a list of selected variants on which you want to perform PCA, and therefore you need to work with only a subset of the variants present in your `vcf.gz` file, execute the following command:

```bash
bcftools view --include 'ID=@variant_list.txt' \
    /path/to/CHR_merged_cohorts.vcf.gz \
    -Oz -o /path/to/VAR_selected_CHR_merged_cohorts.vcf.gz
```

**Note:** In this particular case, because we want to extract variants using only the ID field (which should be formatted as `CHROM:POS:REF:ALT`), the `variant_list.txt` file must be a single-column file. Each row in this file should contain a distinct variant ID in the following format:`CHROM:POS:REF:ALT`


## 10\) Running PCA with Plink

Once the final merged and normalized VCF file (e.g., `merged_cohorts.vcf.gz` or `FIXREF_CHR_merged_cohorts.vcf.gz` or  `VAR_selected_CHR_merged_cohorts.vcf.gz`) is obtained, PCA can be performed.

Launch the Docker container with `plink`:

```bash
plink --vcf /path/to/merged_cohorts.vcf.gz --pca --double-id --out merged_cohorts
```

Options used:

  * `--vcf`: Specifies the input VCF file.
  * `--pca`: Performs principal component analysis.
  * `--double-id`: Ensures FID and IID are preserved.
  * `--out`: Prefix for output files (`merged_cohorts.eigenvec`, `merged_cohorts.eigenval`, `merged_cohorts.log`).

-----

## Other (Optional): Selecting Only Common Variants between VCFs

If the goal is to keep only the variants present in *both* VCF files before merging (or as a separate analysis):

  * One can use `bcftools isec` (intersection). This command is useful for identifying and keeping only variants common to two or more datasets.

    ```bash
    bcftools isec -n=2 -Oz -o merged_common_variants.vcf.gz \
    /path/to/noCHR_newID_fixref_splt_merged_file_cohort1.vcf.gz \
    /path/to/noCHR_newID_fixref_splt_merged_file_cohort2.vcf.gz
    ```

    The `-n=2` option specifies that a variant must be present in both input files to be included in the `merged_common_variants.vcf.gz` output.

<!-- end list -->

```
```
